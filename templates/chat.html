{% extends "base.html" %}

{% block title %}Chat - {{ session_id }}{% endblock %}

{% block extra_css %}
<style>
    .chat-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-title {
        font-size: 1.5em;
        font-weight: bold;
    }

    .chat-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        height: 70vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .message.human {
        flex-direction: row-reverse;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        line-height: 1.4;
        white-space: pre-wrap; /* Para preservar quebras de linha */
    }

    .message.human .message-bubble {
        background: #007AFF;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.ai .message-bubble {
        background: #E5E5EA;
        color: #000;
        border-bottom-left-radius: 4px;
    }

    .message.system .message-bubble {
        background: #FF6B6B;
        color: white;
        border-radius: 8px;
    }

    .message-info {
        font-size: 0.75em;
        color: #666;
        margin-top: 5px;
        text-align: right;
    }

    .message.human .message-info {
        text-align: left;
    }

    .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .avatar.human {
        background: #007AFF;
        color: white;
    }

    .avatar.ai {
        background: #34C759;
        color: white;
    }

    .avatar.system {
        background: #FF6B6B;
        color: white;
    }

    .no-messages {
        text-align: center;
        color: #666;
        padding: 50px;
        font-size: 1.1em;
    }

    .stats {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        color: white;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-header">
    <div>
        <div class="chat-title">üí¨ {{ session_id }}</div>
        <div style="font-size: 0.9em; opacity: 0.8;">
            {% if messages %}
                {{ messages|length }} mensagens
            {% else %}
                Nenhuma mensagem
            {% endif %}
        </div>
    </div>
    <a href="/" class="btn btn-back">‚Üê Voltar</a>
</div>

<div class="chat-container">
    <div class="messages-container" id="messages">
        {% if messages %}
            {% for message in messages %}
            <div class="message {{ message.sender }}">
                <div class="avatar {{ message.sender }}">
                    {% if message.sender == 'human' %}
                        üë§
                    {% elif message.sender == 'ai' %}
                        ü§ñ
                    {% else %}
                        ‚ö†Ô∏è
                    {% endif %}
                </div>
                <div>
                    <div class="message-bubble">{{ message.message }}</div>
                    <div class="message-info">
                        ID: {{ message.id }}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="no-messages">
            <p>Nenhuma mensagem encontrada para este session_id.</p>
            <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">
                Verifique se o session_id est√° correto: <strong>{{ session_id }}</strong>
            </p>
        </div>
        {% endif %}
    </div>
</div>

{% if messages %}
<div class="stats">
    üìä Total de {{ messages|length }} mensagens | 
    üë§ {{ messages|selectattr('sender', 'equalto', 'human')|list|length }} do usu√°rio | 
    ü§ñ {{ messages|selectattr('sender', 'equalto', 'ai')|list|length }} da IA
</div>
{% endif %}

<script>
// Auto scroll para a √∫ltima mensagem
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messages');
    container.scrollTop = container.scrollHeight;
});
</script>
{% endblock %}
